<!DOCTYPE html>
<html lang="en">
  <head>
    <title>TypeScript, React and Redux - Matt Greer
    </title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <link rel="alternate" href="http://mattgreer.org/feed.xml" type="application/rss+xml" title="Me talking about software and programming">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lato:300,400,700|">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/blog.css">
    <link rel="apple-touch-icon-precomposed" href="/img/apple-touch-icon-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/media/img/apple-touch-icon-57x57-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/media/img/apple-touch-icon-72x72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/media/img/apple-touch-icon-114x114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/media/img/apple-touch-icon-144x144-precomposed.png">
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="title clearfix"><a href="/">
          <h1 class="pull-left">Matt Greer</h1></a>
        <div class="links pull-right"><a href="/things.html">things I've made</a></div>
      </div>
      <div class="banner-bg">
        <div class="banner"></div>
      </div>
    </header>
    <div id="content">
      <div class="container">
        <div class="row">
          <div class="col-md-offset-1 col-md-10">
            <h1>TypeScript, React and Redux</h1>
            <div class="date"><span>26 June 2016</span></div>
            <article class="article">
              <section class="content"><p>Try as I might, I could not get TypeScript and Redux to play nice. I finally pulled it off with a tiny hack, and thought I’d dump what I did. If anyone has a better approach, please <a href="mailto:matt.e.greer@gmail.com">I’m all ears</a></p>
<p><span class="more"></span></p>
<h2 id="setting-up-your-actions">Setting Up Your Actions</h2>
<p>Somewhere in a Redux GitHub issue I found someone who took the approach of using <a href="https://github.com/acdlite/redux-actions">redux-actions</a> and I liked it and adopted it.</p>
<p>For starters, define an <code>Action&lt;T&gt;</code> interface that your actions will conform to</p>
<pre><code class="lang-typescript"><span class="keyword">interface</span> Action&lt;T&gt;{
  <span class="keyword">type</span>: <span class="built_in">string</span>;
  payload: T;
  error?: <span class="built_in">boolean</span>;
  meta?: <span class="built_in">any</span>;
}

<span class="keyword">export</span> <span class="keyword">default</span> Action;
</code></pre>
<p>So far I’m not using <code>error</code> or <code>meta</code>, but that’s what redux-actions calls for so going with it. With this we get statically typed Actions</p>
<pre><code class="lang-typescript"><span class="keyword">import</span> Action from <span class="string">"./action"</span>;
<span class="keyword">export</span> <span class="keyword">const</span> MY_ACTION = <span class="string">"MY_ACTION"</span>;
<span class="keyword">export</span> <span class="keyword">type</span> MY_ACTION = { foo: <span class="built_in">number</span>, message: <span class="built_in">string</span> }

<span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">doMyAction</span>(<span class="params">message: <span class="built_in">string</span></span>): <span class="title">Action</span>&lt;<span class="title">MY_ACTION</span>&gt; </span>{
    <span class="keyword">return</span> {
        <span class="keyword">type</span>: MY_ACTION,
        payload: {
            foo: <span class="number">123</span>,
            message
        }
    }
}
</code></pre>
<p>Exporting both a string and a type named <code>MY_ACTION</code> felt a little weird. But since TypeScript can distinguish them by their type, it works. It reduces the cognitive load a bit when defining actions.</p>
<h2 id="and-the-reducer">And The Reducer</h2>
<p>And now with the action set up, the reducer can consume it</p>
<pre><code class="lang-typescript"><span class="keyword">import</span> Action from <span class="string">"../actions/action"</span>;
<span class="keyword">import</span> { MY_ACTION } from <span class="string">"../actions/myAction"</span>;
<span class="keyword">import</span> { handleActions } from <span class="string">"redux-actions"</span>;

<span class="keyword">const</span> reducer = handleActions({
  [MY_ACTION]: <span class="function"><span class="keyword">function</span>(<span class="params">state, action: Action&lt;MY_ACTION&gt;</span>) </span>{
    <span class="keyword">const</span> massagedFoo = doSomething(action.payload.foo);

    <span class="keyword">return</span> <span class="built_in">Object</span>.assign({}, state, {
      massagedFoo,
      message: action.payload.message
    });
  }
}, {});

<span class="keyword">export</span> <span class="keyword">default</span> reducer;
</code></pre>
<p>Since TypeScript doesn’t yet support <a href="https://github.com/Microsoft/TypeScript/issues/2103">spread on objects</a>, need to resort to <code>Object.assign</code>, which is not a big deal. I also left <code>state</code> as <code>any</code>, but defining its type is doable if you feel like it.</p>
<p>Also a minor point, but I like how redux-actions lets me avoid a switch statement.</p>
<h2 id="time-to-connect-it-all">Time To connect it all</h2>
<h3 id="step-one-the-component">Step One, the component</h3>
<p>Your root component that will receive props from redux is a bit verbose to set up, lots of typing to make everyone happy</p>
<pre><code>import * as React from &quot;react&quot;;
import { connect } from &quot;react-redux&quot;;

import { bindActionCreators } from &quot;redux&quot;;
import * as MyActions from &quot;../actions/myAction&quot;;

interface StateProps {
  massagedFoo: number,
  message: string
}

interface DispatchProps {
  doMyAction(message: string)
}

type Props = StateProps &amp; DispatchProps;

function mapStateToProps(state) {
  return {
    massagedFoo: state.myAction.massagedFoo,
    message: state.myAction.message
  };
}

function mapDispatchToProps(dispatch) {
  return bindActionCreators(MyActions, dispatch)
}

@connect&lt;StateProps, DispatchProps, any&gt;(mapStateToProps, mapDispatchToProps)
export default class Home extends React.Component&lt;Props, any&gt; {
  render() {
    const {
      massagedFoo,
      message,
      doMyAction
    } = this.props;

    return (
      &lt;div&gt;
        &lt;div&gt;foo: {massagedFoo} message: {message}&lt;/div&gt;
        &lt;button onClick={doMyAction.bind(this, &quot;my cool message&quot;)} /&gt;
      &lt;/div&gt;
    );
  }
}
</code></pre><p>I like hooking up <code>connect</code> via decorator, reduces the boilerplate nicely. I also like that my props are all statically typed and how easy it was to combine the state and dispatcher props into one with <code>Props = StateProps &amp; DispatchProps</code>. All in all I’m impressed with how the TypeScript team managed to overlay a typing system that doesn’t get in the way and still lets JavaScript shine through.</p>
<h3 id="step-two-component-meets-store">Step Two, component meets store</h3>
<p>Here is where I found Redux (technically react-redux) and TypeScript disagreed with each other. Hooking up your component to your store just can’t be accomplished in such a way that the TypeScript compiler will be happy with. Here’s the “out of the box” approach</p>
<pre><code class="lang-typescript">import * as React from "react";
import * as ReactDOM from "react-dom";
import { Provider } from "react-redux";
import Home from "./components/Home";
import configureStore from "./store/configureStore";
import { Store } from "redux";

const store: Store = configureStore();

class App extends React.Component&lt;any, any&gt; {
  render() {
    return (
      &lt;Provider store={store}&gt;
        &lt;Home /&gt;
      &lt;/Provider&gt;
    );
  }
}

ReactDOM.render(&lt;App/&gt;, document.querySelector("#myApp"));
</code></pre>
<p>The problem is TypeScript thinks <code>Home</code> requires <code>massagedFoo</code>, <code>message</code> and <code>doMyAction</code> as props</p>
<pre><code>ERROR in ./src/index.tsx
(16,9): error TS2324: Property &#39;massagedFoo&#39; is missing in type &#39;IntrinsicAttributes &amp; IntrinsicClassAttributes&lt;Home&gt; &amp; StateProps &amp; DispatchProps &amp; { children?: ...&#39;.

...
</code></pre><p>I banged my head on this for a while and I’m willing to bet a kosher Redux/TypeScript solution exists somewhere, but I sure couldn’t find it.</p>
<h2 id="cheating-a-little-bit">Cheating A Little Bit</h2>
<p>Redux itself is getting along just fine with TypeScript. The problem is only in react-redux’s <code>Provider</code>. react-redux is a tiny library, it’s just a little bit of glue to get a Redux store into a React component and have the React component update properly whenever the store changes. Even better, react-redux is almost entirely inside <code>connect</code>, if you look at <a href="https://github.com/reactjs/react-redux/blob/master/src/components/Provider.js">Provider’s source</a>, it’s almost doing nothing at all!</p>
<p>All Provider is doing is placing the Redux store on the context, so that the component that <code>connect()</code> generated can find it. So I just wrote my own Provider that does the same thing, in a way that skirts around TypeScript</p>
<pre><code class="lang-typescript"><span class="keyword">import</span> * as React from <span class="string">"react"</span>;

<span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> Provider extends React.Component&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt; {
  <span class="keyword">static</span> childContextTypes = {
    store: React.PropTypes.object.isRequired
  }

  getChildContext() {
    <span class="keyword">return</span> { store: <span class="keyword">this</span>.props.store };
  }

  render() {
    <span class="keyword">return</span> React.createElement(<span class="keyword">this</span>.props.target);
  }
}
</code></pre>
<p>This is enough to make everyone happy. But it’s a little irksome that the Provider is completely relying on <code>any</code>. By using generics, you can fix that</p>
<pre><code class="lang-typescript"><span class="keyword">import</span> * as React from <span class="string">"react"</span>;
<span class="keyword">import</span> { Store } from <span class="string">"redux"</span>;

<span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createProvider</span>&lt;<span class="title">P</span>&gt;(<span class="params"></span>) </span>{
  <span class="keyword">interface</span> ProviderProps&lt;P&gt; {
    store: Store,
    target: React.ComponentClass&lt;P&gt;
  }

  <span class="keyword">return</span> <span class="keyword">class</span> Provider extends React.Component&lt;ProviderProps&lt;P&gt;, <span class="built_in">any</span>&gt; {
    <span class="keyword">static</span> childContextTypes = {
      store: React.PropTypes.object.isRequired
    }

    getChildContext() {
      <span class="keyword">return</span> { store: <span class="keyword">this</span>.props.store };
    }

    render() {
      <span class="keyword">return</span> React.createElement(<span class="keyword">this</span>.props.target);
    }
  };
}
</code></pre>
<p>then over in index.tsx</p>
<pre><code class="lang-typescript"><span class="keyword">import</span> * as React from <span class="string">"react"</span>;
<span class="keyword">import</span> * as ReactDOM from <span class="string">"react-dom"</span>;
<span class="keyword">import</span> createProvider from <span class="string">"./createProvider"</span>;
<span class="keyword">import</span> Home, { HomeProps } from <span class="string">"./components/Home"</span>;
<span class="keyword">import</span> configureStore from <span class="string">"./store/configureStore"</span>;

<span class="keyword">const</span> store = configureStore();
<span class="keyword">const</span> Provider = createProvider&lt;HomeProps&gt;();

<span class="keyword">class</span> App extends React.Component&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt; {
  render() {
    <span class="keyword">return</span> (
      &lt;Provider store={store} target={Home} /&gt;
    );
  }
}

ReactDOM.render(&lt;App/&gt;, <span class="built_in">document</span>.querySelector(<span class="string">"#myApp"</span>));
</code></pre>
</section>
            </article>
          </div>
        </div>
      </div>
    </div>
    <footer>
      <div class="container">
        <div class="row">
          <div class="col-md-offset-1 col-md-1">
            <div class="wave hidden-xs hidden-sm"></div>
          </div>
          <div class="col-md-5">
            <div class="about"><p>Hi, I’m Matt Greer, thanks for stopping by. I’m a developer in the San Jose area. I am mostly interested in web related technology, but also dabble in games, Clojure(Script), visualization and sometimes devops-ish stuff. </p>
<p>This site was created with <a href="http://wintersmith.io/">Wintersmith</a>. It is hosted by GitHub, and its source is <a href="https://github.com/city41/blog">here</a>.</p>

            </div>
          </div>
          <div class="col-md-4"><ul>
<li><i class="fa fa-envelope"></i> <a href="mailto:matt.e.greer@gmail.com">matt.e.greer@gmail.com</a></li>
<li><i class="fa fa-twitter"></i> <a href="http://twitter.com/cityfortyone">@cityfortyone</a></li>
<li><i class="fa fa-stack-overflow"></i> <a href="http://stackoverflow.com/users/194940/matt-greer">StackOverflow</a></li>
<li><i class="fa fa-github"></i> <a href="https://github.com/city41">GitHub</a></li>
<li><i class="fa fa-rss"></i> <a href="/feed.xml">rss</a></li>
</ul>

          </div>
        </div>
      </div>
    </footer>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-47850394-1', 'mattgreer.org');
      ga('send', 'pageview');
    </script>
  </body>
</html>